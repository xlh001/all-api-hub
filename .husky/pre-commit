#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# Format check
echo "ğŸ“ Checking code formatting..."
if ! pnpm format:check; then
  echo "âŒ Formatting issues found. Running auto-fix..."
  echo "ğŸ“ Auto-formatting code..."
  pnpm format
  git add -u  # è‡ªåŠ¨æ·»åŠ æ ¼å¼åŒ–åçš„æ–‡ä»¶
  echo "âœ… Code formatted and staged"
fi

# Lint check
echo "ğŸ” Running linter..."
if ! pnpm lint; then
  echo "âŒ Linting issues found. Attempting to auto-fix..."
  echo "ğŸ”§ Auto-fixing lint issues..."
  pnpm lint:fix
  git add -u  # è‡ªåŠ¨æ·»åŠ ä¿®å¤åçš„æ–‡ä»¶
  echo "âœ… Lint issues fixed and staged"
fi

# æœ€åéªŒè¯ä¸€æ¬¡ï¼Œåªæœ‰æ— æ³•è‡ªåŠ¨ä¿®å¤çš„æ‰æŠ¥é”™
echo "ğŸ” Final validation..."
pnpm format:check || {
  echo "âŒ Formatting issues remain after auto-fix. Please check manually."
  exit 1
}

pnpm lint || {
  echo "âŒ Lint issues remain after auto-fix. Please check manually."
  exit 1
}

echo "âœ… All pre-commit checks passed!"