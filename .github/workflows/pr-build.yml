name: pr-build-preview

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to build"
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  build-artifact:
    runs-on: ubuntu-latest

    steps:
      - name: Get PR details (manual trigger)
        if: github.event_name == 'workflow_dispatch'
        id: pr_details
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ inputs.pr_number }}
            });
            core.setOutput('ref', pr.head.ref);
            core.setOutput('sha', pr.head.sha);
            core.setOutput('number', pr.number);

      - name: Checkout code (manual trigger)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v5
        with:
          ref: refs/pull/${{ inputs.pr_number }}/merge

      - name: Checkout code (pull_request)
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Build extension bundles
        run: pnpm zip:all

      - name: Collect artifact names
        id: collect_artifacts
        run: |
          if ls .output/*.zip 1> /dev/null 2>&1; then
            {
              echo "files<<EOF"
              for file in .output/*.zip; do
                basename "$file"
              done
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          else
            echo "files=No artifacts found" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: pr-build-${{ github.event_name == 'workflow_dispatch' && inputs.pr_number || github.event.pull_request.number }}-${{ github.run_attempt }}
          path: .output/*.zip
          include-hidden-files: true

      - name: Comment build info on PR
        uses: actions/github-script@v7
        env:
          ARTIFACT_LIST: ${{ steps.collect_artifacts.outputs.files }}
          PR_NUMBER: ${{ github.event_name == 'workflow_dispatch' && inputs.pr_number || github.event.pull_request.number }}
          COMMIT_SHA: ${{ github.event_name == 'workflow_dispatch' && steps.pr_details.outputs.sha || github.event.pull_request.head.sha }}
        with:
          script: |
            const marker = "<!-- pr-build-artifact -->";
            const prNumber = parseInt(process.env.PR_NUMBER);
            const commitSha = process.env.COMMIT_SHA;
            const artifactList = (process.env.ARTIFACT_LIST || "See workflow run for details.")
              .split("\n")
              .filter(Boolean)
              .map((name) => `- ${name}`)
              .join("\n") || "- (none)";

            const body = [
              marker,
              `**Preview build ready** for commit \`${commitSha.slice(0, 7)}\`.`,
              "",
              "Artifacts:",
              artifactList,
              "",
              `Download from workflow run: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              "",
              "_This build is for review only and is not released._",
            ].join("\n");

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100,
            });

            const existing = comments.find((comment) => comment.body && comment.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body,
              });
            }
