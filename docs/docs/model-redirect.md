# 模型重定向（Model Redirect）

> 自动为 New API 渠道生成“标准模型 → 实际模型”的映射，让你在下游只需调用统一的模型名称（如 `gpt-4o`），由系统自动路由到各个上游中转站实际提供的模型。

## 功能概览

- **统一模型调用入口**
  - 你可以在 New API 中统一使用一组“标准模型名称”（如 `gpt-4o`、`claude-4.5-haiku`）。
  - 模型重定向会将它们映射到各个渠道真实可用的模型名。
- **自动生成映射**
  - 基于渠道上报的 `models` 列表和一组“标准模型清单”，自动计算最合适的对应关系。
  - 支持按渠道增量合并，保留你手工配置的部分映射。
- **结合模型同步与渠道管理使用**
  - 通常与 **New API 模型列表同步** 和 **New API 渠道管理** 搭配使用：
    - 模型同步负责把上游可用模型列表拉到 New API。
    - 模型重定向负责把这些模型对齐到一组“标准模型”。

## 前置条件

- 已在插件中配置好 **New API 集成设置**：
  - 填写 **管理员 URL**、**Admin Token**、**用户 ID**。
- New API 中存在至少一个有效渠道，并且渠道的 `models` 字段包含可用模型列表。
- 已完成一次模型同步（建议），以确保渠道内的模型列表是最新的。

## 设置入口

1. 打开插件 → 进入 **设置** 页面。
2. 切换到 **“New API”** 标签页。
3. 在页面下方找到 **“模型重定向”** 区域（`id="model-redirect"`）。
4. 可以看到：
   - 启用开关
   - 标准模型多选列表
   - “立即重新生成映射”按钮

## 主要配置项

- **启用模型重定向**
  - 打开后，模型重定向算法会在你手动点击“重新生成”或特定同步流程中被调用。
- **标准模型列表**
  - 内置常见厂商的标准模型，例如：
    - OpenAI 系列：`gpt-4o`、`gpt-4o-mini`、`o3`、`o3-mini` 等。
    - Anthropic / Google / Mistral / DeepSeek / 通义千问等主流模型。
  - 你可以按需增删，或手动输入自定义标准模型名。
- **立即重新生成映射**
  - 点击按钮后，插件会：
    - 拉取所有渠道列表（过滤掉手动/自动禁用的渠道）。
    - 对每个渠道计算“标准模型 → 实际模型”的映射表。
    - 将结果与现有 `model_mapping` 合并后写回（新键覆盖旧值）。
- **清空模型重定向映射（危险操作）**
  - 点击后会先打开 **预览/选择** 弹窗，加载当前站点下的渠道列表：
    - 默认 **全选** 所有渠道；
    - 支持 **全选 / 全不选** 快捷操作；
    - 支持逐个勾选需要清空的渠道。
  - 在预览弹窗中点击“继续”后，会出现 **二次确认**（不可误触）：
    - 确认后将对所选渠道写入 `model_mapping = "{}"`（清空映射）。
    - **未选择的渠道不会被修改**。
    - 该操作会清空你可能手工维护的自定义映射，且 **不可撤销**。
  - 若出现 **部分失败**：
    - 插件会继续尝试清空其余渠道；
    - UI 会给出成功/失败摘要，并在弹窗中展示失败明细，便于你重试或手工处理。

## 工作原理（简要）

1. 读取用户偏好中的模型重定向配置：
   - 若未启用，则直接返回并提示“功能已关闭”。
2. 计算标准模型集合：
   - 若你未自定义，则使用内置的标准模型全集。
3. 通过 New API 管理接口获取所有渠道列表。
4. 对每个渠道：
   - 解析渠道的 `models` 字段为实际模型列表。
   - 对每个标准模型执行多阶段匹配：
     - 若渠道本身就包含同名模型，则跳过（无需重定向）。
     - 否则根据统一的“模型归一化规则”（`renameModel`）寻找最相近的候选实际模型。
     - 在候选集合中挑选尚未占用的实际模型，写入 `standardModel -> actualModel` 映射。
   - 将新映射与渠道已有的 `model_mapping` JSON 合并并写回。
5. 汇总成功更新的渠道数量与失败原因，在 UI 中以 toast 显示。

## 典型使用场景

- **统一 OpenAI 兼容模型名**
  - 不同上游可能用略有差异的模型命名（例如带前缀/后缀）。
  - 通过模型重定向，可在下游应用中始终使用统一名称，例如 `gpt-4o`，由 New API 按映射路由到实际模型。
- **与渠道优先级配合**
  - 在 New API 中为不同渠道设置权重/优先级，再配合统一的标准模型名，实现多上游容灾和流量分配。

## 常见问题

- **提示 New API 配置缺失**
  - 请先在 **“基础设置 → New API 集成设置”** 中填写管理员 URL、Token 和用户 ID 并保存。
- **提示功能未启用**
  - 确认已在“模型重定向”区域打开“启用模型重定向”开关。
- **某些标准模型未生成映射**
  - 说明在对应渠道中未找到可匹配的实际模型，或所有候选都已被其它标准模型占用。
  - 可以检查渠道的 `models` 字段是否完整，或调整标准模型列表。
- **原有手动配置会被覆盖吗？**
  - 对于同一个 `standardModel`，新生成的映射会覆盖旧值；
  - 其它手工添加但未被覆盖的键仍会保留在 `model_mapping` 中。

## 使用建议

- 建议先在测试环境或少量渠道上验证生成结果，再在全部渠道上执行批量重定向。
- 若你主要通过 **New API 模型同步** 维护模型列表，推荐在完成同步后再点击“重新生成映射”。

## 相关文档

- [New API 模型列表同步](./new-api-model-sync.md)
- [New API 渠道管理](./new-api-channel-management.md)
- [快速导出站点配置](./quick-export.md)
