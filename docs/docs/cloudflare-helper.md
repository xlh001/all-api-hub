# Cloudflare 过盾助手

> 适用于开启 Cloudflare 五秒盾（或更严格 Bot Fight Mode）的聚合中转站，确保插件既能识别账号信息，也能在请求被限制时自动重试。

## 功能概述

- **自动检测**：识别到页面标题包含 `Just a moment`、存在 `#cf-content`、或 API 返回 401/403/429 等状态码时，自动触发过盾流程。
- **临时窗口**：后台开启与目标域同源的临时标签页，沿用浏览器 Cookie，完成 Cloudflare 的 JS/人机挑战后再返回原页面。
- **请求降级**：普通 `fetch` 失败时，改由临时窗口携带 Cookie 重放请求，避免跨域/凭据缺失导致的无限重试。
- **手动兜底**：若 Cloudflare 判定需要用户交互，会自动弹出窗口提示在 20 秒内完成验证。

## 使用步骤

1. **登录目标站点**，在插件中新增账号 → 填写站点地址 → 点击“自动识别”。
2. 如遇 Cloudflare 提示，浏览器会自动弹窗；只需保持窗口前台，等待自动完成验证或按提示点选。
3. 验证通过后，插件会自动回到识别流程，继续读取 Access Token、余额、模型列表等数据。
4. 若是 API 请求阶段触发限流（常见于 CC Switch/CherryStudio 导出或 New API 同步），系统会自动启用临时窗口重发，无需额外操作。

## 注意事项

- **IP 质量**：若连续无法通过，需要更换网络或在站点侧临时放宽防护；默认超时时间为 20 秒。
- **弹窗权限**：请允许浏览器弹出窗口，否则插件无法创建临时标签页。
- **重复挑战**：若频繁触发 429，可在 New API 渠道管理中调低速率或启用模型白名单，减少无效请求。

## 常见问题

| 场景 | 解决方案 |
|------|----------|
| 弹窗秒关 | 查看浏览器地址栏右侧是否拦截弹窗，允许后重新识别。 |
| 一直停留在 “Just a moment” | 在弹出的窗口中手动完成验证码；若仍失败，请更换 IP。 |
| API 导出仍报 403 | 手动点击“再次导出”，后台会复用刚通过过盾的 Cookie；若失败，检查目标站是否限制管理员 Token。 |
| 无弹窗但识别失败 | 站点可能移除了 Cloudflare，但接口返回 401（凭据失效），请重新登录站点并刷新插件数据。 |

## 相关文档

- [Cloudflare 防护与临时窗口降级（快速上手）](./get-started.md#_5-8-cloudflare-防护与临时窗口降级)
- [快速导出站点](./quick-export.md)
- [New API 渠道管理](./new-api-channel-management.md)
- [权限管理（可选权限）](./permissions.md)
