# 自动刷新与实时数据

> 让账号余额、用量、模型列表保持最新，无需每次手动点击“刷新”。同时提供后台定时器与弹窗打开时的即时刷新双重策略。

## 功能概览

- **后台定时器**：由 `autoRefreshService` 驱动，在浏览器后台定时调用账号刷新接口，支持 60 秒～数小时的自定义间隔。
- **打开即刷新**：可选的“打开插件时自动刷新”开关，适合关闭后台定时器但仍想保证数据同步的场景。
- **最小间隔保护**：独立设置 `minInterval`，在“非强制刷新”场景下避免对同一账号过于频繁地重复请求。
- **即时刷新**：随时执行“立即刷新”，立刻获取所有站点最新余额/额度。

## 前置条件

1. 至少已成功添加一个站点账号。
2. 浏览器需保持扩展运行（移动端 Kiwi/Firefox 亦可，但需确保浏览器未被系统杀死）。
3. 若站点存在 Cloudflare 防护，请先参考 [Cloudflare 过盾助手](./cloudflare-helper.md) 完成校验。

## 设置入口

1. 打开插件 → **设置**。
2. 选择 **“基础设置 → 自动刷新”** 选项卡，进入 `RefreshSettings` 面板。

## 主要配置项

| 选项 | 说明 |
|------|------|
| **启用自动刷新** | 控制后台定时器的开关；关闭后仅保留手动刷新。 |
| **刷新间隔（秒）** | 定时器运行周期，对应 `accountAutoRefresh.interval`。输入 <60 秒会被拦截提示。 |
| **打开插件时自动刷新** | 每次打开弹窗时触发一次刷新（非强制），会受到最小间隔保护影响。 |
| **最小刷新间隔（秒）** | 同一账号在“非强制刷新”场景下的最小刷新间隔保护；最低 30 秒。 |
| **恢复默认** | 调用 `resetAutoRefreshConfig()`，恢复到内置默认的自动刷新配置。 |

## 工作原理

1. 用户保存设置后，通过 `UserPreferencesContext` 将 `accountAutoRefresh` 写入本地偏好。
2. 背景页收到 `RuntimeActionIds.AutoRefreshUpdateSettings`（wire: `autoRefresh:updateSettings`）消息，调用 `autoRefreshService.setupAutoRefresh()`：
   - 若开关关闭或配置不完整则停止定时器。
   - 否则根据间隔创建 `setInterval`，周期性执行 `accountStorage.refreshAllAccounts(false)`。
3. 刷新结果（成功/失败）会通过 `AUTO_REFRESH_UPDATE` 消息广播到前端，若弹窗未打开则静默忽略。

## 推荐策略

- **高频检查**：核心账号建议设置 300～600 秒，保证余额告警及时。
- **低频 + 打开刷新**：若担心站点限流，可将后台定时器关闭，仅保留“打开即刷新”。
- **配合通知**：结合浏览器自身通知或脚本，监听 `AUTO_REFRESH_UPDATE` 以二次开发提醒。

## 常见问题

| 问题 | 解决方案 |
|------|----------|
| 定时刷新未触发 | 可能是浏览器被系统休眠，重新打开扩展或手动点击“立即刷新”；必要时尝试降低间隔。 |
| 频繁触发 Cloudflare 限流 | 适当增大刷新间隔，并确保 [Cloudflare 过盾助手](./cloudflare-helper.md) 能正常弹窗校验。 |
| 刷新失败且提示 401/403 | 登录状态已失效，重新在浏览器访问对应站点并刷新插件。 |
| 多设备冲突 | 建议配合 [WebDAV 备份与自动同步](./webdav-sync.md) 统一账号数据，避免重复刷新同一站点。 |

## 相关文档

- [Cloudflare 过盾助手](./cloudflare-helper.md)
- [自动签到](./auto-checkin.md)
- [WebDAV 备份与自动同步](./webdav-sync.md)
- [权限管理（可选权限）](./permissions.md)
