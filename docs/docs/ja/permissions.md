# 権限管理（オプション権限）

> 一時的なウィンドウでのシールド回避、自動更新、またはバックグラウンドでのCookie/リクエストヘッダーの追加が必要な場合にのみ、これらのオプション権限を付与する必要があります。日常的な使用では、すべてオフのままで問題ありません。

## 機能概要

- **オプション権限の一元管理**
  - 「権限管理」ページで、拡張機能のオプション権限の状態を一括して確認、付与、または取り消しできます。
- **Cloudflareシールド回避との統合**
  - 一部の権限は、一時的なウィンドウでのシールド回避（例: Cloudflare 5秒シールド）をサポートするために使用され、サイトにファイアウォールが存在する場合でもデータを正常に更新できるようにします。
- **いつでも取り消し可能**
  - すべてのオプション権限は、ブラウザ設定または拡張機能の「権限管理」ページでいつでもオフにでき、コアのオフライン機能には影響しません。

## 設定へのアクセス

1. 拡張機能を開く → **設定** ページに移動します。
2. ブラウザがオプション権限をサポートしている場合、**「権限管理 / Permissions」** タブが表示されます。
3. クリックして移動すると、現在の拡張機能で利用可能なオプション権限のリストと状態を確認できます。

> ヒント：お使いのブラウザが関連する権限をサポートしていないか、有効にしていない場合、このタブは表示されない可能性があります。

## サポートされている権限タイプ

具体的な権限名はブラウザによって若干異なる場合がありますが、通常は以下を含みます。

- **Cookies（Cookie権限）**
  - 目的：拡張機能が制御された範囲内で必要なCookieを読み取り、バックグラウンドリクエストで認証情報を付加できるようにします。
  - 典型的なシナリオ：
    - 一時的なウィンドウでのシールド回避が完了した後、同じセッションCookieをバックグラウンドの更新リクエストに含めます。

- **Web Request（ネットワークリクエスト監視）**
  - 目的：拡張機能が特定のシナリオで送信されようとしているリクエストを監視できるようにします（例: シールド回避プロセスに必要なリクエストヘッダーを追加するため）。
  - 典型的なシナリオ：
    - リクエストがファイアウォールによってブロックされたかどうか、一時的なウィンドウでの再試行をトリガーする必要があるかどうかを判断します。

- **Web Request Blocking（ネットワークリクエストのブロック/変更）**
  - 目的：リクエストが送信される前にリクエストを同期的に変更し（例: Cookie、ヘッダーの追加）、ファイアウォール/Cloudflareの前で認証情報が正しく伝達されることを保証します。
  - 典型的なシナリオ：
    - Cloudflareシールド回避またはCookie付きの更新リクエストがサイト保護を安定して通過できることを確実にします。

> 拡張機能は、これらの権限を利用してあなたと関係のないサイトをスキャンすることはありません。あなたが接続している中継サイトのドメイン上でのみ、必要なワークフローで使用されます。

## ステータスと操作

権限管理ページでは、以下を確認できます。

- **ステータス表示**
  - 「検出中 / Checking…」：ブラウザと権限の状態を同期しています。
  - 「付与済み / Granted」：現在、ブラウザによって許可されています。
  - 「未付与 / Not granted」：現在、許可されていません。
- **操作ボタン**
  - **許可（推奨）**：ブラウザに権限リクエストのポップアップを開始します。
  - **取り消し**：現在の権限を自発的に取り消します。
  - **状態を更新**：ブラウザ設定で手動で権限を変更した後、クリックして状態を同期できます。

## これらの権限をいつ有効にする必要がありますか？

- 以下のシナリオで有効にすることを検討してください：
  - Cloudflareまたは他のファイアウォール保護がある中継サイトに頻繁にアクセスし、シールド回避を自動で完了してデータを更新したい場合。
  - バックグラウンドで大量のアカウントデータを自動更新する必要があり、保護による失敗を可能な限り減らしたい場合。
- 以下のシナリオでは、オフのままで問題ありません：
  - 少量のアカウントをたまに手動で更新するだけの場合。
  - 使用している中継サイトに追加のファイアウォールや5秒シールドなどの保護がない場合。

## プライバシーとセキュリティに関する説明

- 拡張機能はデフォルトで **完全にオフラインで動作します**。すべてのアカウントとサイト設定はブラウザのローカルに保存されます。
- オプション権限は以下の状況でのみ有効になります：
  - 権限管理ページで明示的に「許可」をクリックした場合。
  - ブラウザが権限リクエストダイアログを表示し、あなたが確認した場合。
- あなたはいつでも：
  - 「権限管理」ページで「取り消し」をクリックする。
  - またはブラウザ自身の拡張機能管理インターフェースで関連する権限を削除する。

## トラブルシューティング

- **「許可」をクリックしても何も反応がない場合？**
  - ブラウザが権限ダイアログを表示しなかったか、またはシステムによってブロックされた可能性があります。
  - アドレスバーの近くに権限アイコンやヒントがあるか確認してください。
- **シールド回避/更新がまだ失敗する場合？**
  - Cloudflareシールド回避関連の設定が有効になっていることを確認し、[Cloudflare 過盾助手](./cloudflare-helper.md) ドキュメントを参照してください。
  - お使いのネットワーク環境（プロキシ、ファイアウォール、IP品質など）を確認してください。

## 関連ドキュメント

- [Cloudflare 過盾助手](./cloudflare-helper.md)
- [自動更新とリアルタイムデータ](./auto-refresh.md)
- [WebDAV バックアップと自動同期](./webdav-sync.md)