# CLIProxyAPI の統合とワンクリックインポート

> プロキシステーションアカウントをローカルの CLIProxyAPI 管理インターフェースにワンクリックでインポートし、OpenAI 互換プロバイダー設定を自動生成することで、手動での設定ファイルメンテナンスを不要にします。

## 機能概要

-   **管理インターフェース連携**
    *   CLIProxyAPI の Management API（`/openai-compatibility`）を通じて設定を読み書きします。
    *   既存のプロバイダーに API キーを追記/更新したり、新しいプロバイダーを自動で作成したりする機能をサポートします。
-   **APIキーのワンクリックインポート**
    *   APIキーリストで「CLIProxyAPI にインポート」をクリックするだけで、現在のサイトの Base URL と APIキーを CLIProxyAPI に書き込むことができます。
-   **重複設定の回避**
    *   サイト名と `Base URL` を自動的に再利用し、同じプロバイダーが検出された場合は APIキーリストのみを更新し、重複するエントリは作成しません。

## 前提条件

-   互換性のある **CLIProxyAPI** がデプロイまたは実行されており、管理インターフェースが有効になっていること。
    *   例のアドレス：`http://localhost:8317/v0/management`
    *   `GET/PUT/PATCH /openai-compatibility` などのインターフェースをサポートしています。
-   管理インターフェースの **Management Key**（認証用）を所有していること。
-   All API Hub で以下が完了していること：
    *   少なくとも1つのプロキシステーションアカウントを追加し、利用可能な APIキーを取得していること。

## 設定エントリ

1.  プラグインを開き → **設定** ページに移動します。
2.  **「CLIProxyAPI」** グループ（`基本設定 → CLIProxyAPI` タブ）に切り替えます。
3.  以下のフィールドを入力します。
    *   **管理インターフェース基本 URL**：例 `http://localhost:8317/v0/management`
    *   **管理キー（Management Key）**：管理インターフェースにアクセスするための APIキー。
4.  保存後、設定はローカルのプリファレンスに保存され、以降のインポート操作で再利用されます。

## APIキーリストからのワンクリックインポート

1.  プラグインを開き → **APIキー管理** ページに移動します。
2.  CLIProxyAPI にインポートしたいサイトの APIキーカードを見つけます。
3.  APIキーの右側にある CLIProxyAPI アイコンボタンをクリックします（通常、CherryStudio / CC Switch / New API ボタンの隣にあります）。
4.  プラグインは以下を実行します。
    *   CLIProxyAPI の設定（基本 URL と管理キー）を読み取ります。
    *   サイトの `Base URL` を使用して OpenAI 互換アドレスを生成します（`/v1` を自動的に付加します）。
    *   サイト名または Base URL をプロバイダー名として使用します。
    *   （オプション）インポートポップアップで **モデルマッピング**（オリジナルモデル → エイリアス）を設定します。ポップアップは、アップストリームの `/v1/models` からモデルリストをフェッチしようとし、オリジナルモデルの選択を容易にします。
    *   CLIProxyAPI を呼び出します。
        *   同名または同じ `base-url` のプロバイダーが既に存在する場合：
            *   重複排除後、`api-key-entries` に現在の APIキーを追記します。
        *   存在しない場合：
            *   現在の APIキーと基本情報のみを含む新しいプロバイダーエントリを作成します。
5.  操作完了後、右上にインポート結果の通知（成功/失敗とエラー原因）が表示されます。

## CLIProxyAPI へのインポート後の効果

-   CLIProxyAPI の設定に、以下のような構造が新規追加または更新されます。
    *   `name`：サイト名（または Base URL）に由来します。
    *   `base-url`：対応するプロキシステーションの `/v1` OpenAI 互換インターフェースを統一的に指します。
    *   `api-key-entries`：1つまたは複数の `api-key` レコードを含み、CLIProxyAPI 内で手動で編集を続けることができます。
-   これは以下のことを意味します。
    *   CLIProxyAPI レイヤーで複数のアップストリームプロキシステーションの APIキーを一元的に管理できます。
    *   All API Hub は基本設定情報の同期を担当し、その後の詳細は CLIProxyAPI 内でカスタマイズできます。

## よくある質問

-   **CLIProxyAPI が設定されていないというプロンプトが表示される**
    *   **設定 → CLIProxyAPI** で基本 URL と管理キーが入力されているか確認してください。
    *   `/openai-compatibility` が余分に含まれていないことを確認してください。管理インターフェースのプレフィックス、例えば `.../v0/management` であるべきです。
-   **401/403 またはその他の HTTP エラーが返される**
    *   管理キーが正しいこと、および現在のユーザーアカウントに管理インターフェースへのアクセス権限があることを確認してください。
    *   CLIProxyAPI のバックエンドログを確認し、ルーティングとメソッド（GET/PUT/PATCH）が有効になっているか確認してください。
-   **重複してインポートすると多くのレコードが生成されますか？**
    *   いいえ。プラグインは `base-url` または名前に基づいて既存のプロバイダーを検索します。
        *   存在する場合、`api-key-entries` のみを更新し、同じ APIキーの重複排除を行います。
        *   存在しない場合にのみ、新しいプロバイダーを作成します。

## 使用上の推奨事項

-   少数のテストアカウントでインポート効果を検証してから、本番環境で使用することをお勧めします。
-   All API Hub の **クイックエクスポート** 機能と連携して、同じアップストリームサイト群を New API / CLIProxyAPI などの複数のダウンストリームシステムに同期させることができます。

## 関連ドキュメント

-   [サイト設定のクイックエクスポート](./quick-export.md)
-   [New API チャネル管理](./new-api-channel-management.md)
-   [New API モデルリスト同期](./new-api-model-sync.md)