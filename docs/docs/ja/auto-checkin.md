# 自動チェックインとチェックイン監視

> チェックインをサポートする統合アカウントが毎日定時にチェックインし、クォータを蓄積し、チェックインログを同期することで、手動操作の忘れを防ぎます。

## 機能概要

-   **サイト検出**：アカウント識別時にサイトにチェックイン入口があるかを自動で判断し、アカウント詳細で「チェックイン検出」のオン/オフを切り替えられます。
-   **カスタムチェックイン入口**：カスタマイズされたサイト向けに、`customCheckInUrl` と `customRedeemUrl` を設定でき、同時にチャージページを連動して開くかを決定できます。
-   **自動チェックインスケジューリング**：`autoCheckinScheduler` は `chrome.alarms` に基づいて**毎日1回**の通常の自動チェックインを実行し、**当日失敗したアカウント**に対しては独立したアラームでリトライします（次回のデイリー計画には影響しません）。
-   **実行履歴**：毎回実行時にログが生成され、成功/失敗理由、最終実行時間、次回のデイリー計画、および（もしあれば）次回の再試行計画が含まれます。「自動チェックイン」ページで確認できます。

## 使用前提

1.  **アカウント管理 → アカウントを編集** で「チェックイン検出」を有効にし、手動でチェックインが成功することを確認します。
2.  自動チェックインが必要なアカウントに対して「自動チェックイン」スイッチをオンにします（デフォルトでオン、個別アカウントでオフにできます）。
3.  **設定 → 自動チェックイン** でグローバル自動チェックインを有効にし、時間ウィンドウを設定します。
4.  ブラウザが `chrome.alarms` をサポートしている必要があります（Chrome、Edge、Kiwi ブラウザは正常に動作しますが、一部の Firefox モバイル版はサポートしていない可能性があります）。

## 設定手順

### 1. アカウントレベルのスイッチ

-   任意のアカウント詳細 → 「その他の設定」を開きます。
-   「チェックイン検出」を有効にすると、以下を設定できます：
    -   カスタムチェックインURL（サイトのデフォルト入口が利用できない場合）。
    -   カスタムチャージURLおよび「チェックイン時にチャージページも開く」。
    -   「自動チェックイン」スイッチ（オフにすると、グローバルで有効になっていても、そのアカウントは自動チェックインに参加しません）。

### 2. グローバル時間ウィンドウ

**設定 → 自動チェックイン** パネルで：

| オプション | 説明 |
|------|------|
| **自動チェックインを有効にする** | グローバル `globalEnabled` を制御します。オフにするとアラームは作成されません。 |
| **時間ウィンドウ開始 / 終了** | 24時間形式で、夜間をまたぐことも可能です（例：22:00 → 06:00）。スケジューラーはこの時間範囲内でランダムな時間を選択して実行します。 |
| **実行履歴を表示** | 「自動チェックイン」ページに素早く移動し、ステータスとログを確認します。 |
| **デフォルトに戻す** | `resetAutoCheckinConfig()` を呼び出し、09:00～18:00、無効状態に戻します。 |

### 3. 実行ステータスを確認

-   **プラグインサイドバー → 自動チェックイン** ページを開くと、以下を確認できます：
    -   最新の実行結果（成功 / 部分成功 / 失敗）。
    -   次回のデイリー計画時間 `nextDailyScheduledAt`。
    -   （もしあれば）次回の再試行計画時間 `nextRetryScheduledAt`。
    -   アカウントごとのログ（所要時間、失敗理由など）。
-   「今すぐ実行」をクリックすると、デバッグ用に `autoCheckin:runNow` を手動でトリガーできます。

## 動作原理

1.  **設定の書き込み**：`UserPreferencesContext` は `autoCheckin` 設定をローカル設定に保存し、`sendRuntimeMessage` を通じてバックグラウンドに通知します。
2.  **スケジューリングの初期化**：`autoCheckinScheduler.initialize()` は拡張機能の起動時にアラームリスナーを作成します：
    -   **デイリーアラーム**：通常の自動チェックイン（1日最大1回）。
    -   **リトライアラーム**：当日の通常実行で失敗したアカウントがある場合にのみトリガーされます（失敗したアカウントのみをリトライ）。
3.  **実行フロー**：
    -   アカウントを読み込み、スナップショットを構築します（検出が有効なアカウントは「アカウント検出ステータス」に表示されます）。
    -   条件を満たすアカウントをフィルタリングします（検出がオン、自動チェックインが許可されている、プロバイダーが存在し利用可能）。
    -   `checkIn.siteStatus.isCheckedInToday` を使用して実行するかどうかを**判断しません**（このフィールドは信頼できません）。プロバイダーが返す `already_checked` が「チェックイン済み」の実際の判断ソースとなります。
    -   対応するプロバイダー（現在 Veloera が組み込まれており、拡張可能）を並行して呼び出し、成功/失敗情報を記録します。
    -   成功または `already_checked` の場合、`accountStorage.markAccountAsSiteCheckedIn()` に書き込まれます。失敗した場合はログに記録され、当日のリトライキューに入ります（リトライが有効な場合）。
    -   最終的に `autoCheckinStorage` に書き込まれ、フロントエンドページで各アカウントのステータスとリトライ情報が表示されます。
4.  **再スケジューリング**：
    -   通常のデイリー実行が完了すると、**翌日**のためにデイリーアラームが再計画されます（1日最大1回を保証）。
    -   当日失敗したアカウントが存在し、リトライが有効な場合、リトライアラームが計画され、アカウントごとに当日の試行回数が記録されます（`maxAttemptsPerDay` に達するとリトライは停止します）。

## ベストプラクティス

-   **時間ウィンドウの推奨**：成功率を高めるため、深夜またはサイトのオフピーク時間帯（例：02:00-05:00）に設定することをお勧めします。
-   **デバイス間同期**：[WebDAV バックアップと自動同期](./webdav-sync.md)と組み合わせて、複数のデバイスで同じアカウントとチェックイン設定を共有し、重複チェックインを避けます。
-   **異常通知**：現在通知機能は組み込まれていません。バックグラウンドページの `autoCheckinStorage` を自分で監視するか、「自動チェックイン」ページで失敗記録を確認してください。

## よくある質問

| 問題 | トラブルシューティング方法 |
|------|----------|
| ページに「未計画 / 無効 / 再試行待ちなし」と表示される | 「無効」：グローバル自動チェックインスイッチがオフです。<br/>「再試行未有効」：再試行ポリシーが有効になっていません。<br/>「再試行待ちなし」：再試行は有効になっていますが、現在失敗したアカウントはありません。<br/>「未計画」：有効になっていますが、ブラウザが `chrome.alarms` をサポートしていないか、アラームがまだ作成されていない/クリアされています。設定を再保存するか、Chrome/Edge を使用してみてください。 |
| 特定のアカウントが毎日失敗する | そのサイトが自動チェックインプロバイダーをサポートしているか確認し、必要に応じてそのアカウントの自動チェックインを無効にして手動に切り替えてください。 |
| カスタムURLが無効 | ブラウザで直接アクセスしてチェックインが成功するか確認してください。一部のサイトでは追加のフォームデータが必要ですが、現在サポートされているのはGET/シンプルなPOSTのチェックインフローのみです。 |
| 複数のアカウントが重複してチェックインされる | 複数のデバイスが同時に実行している可能性があります。WebDAV同期を有効にして設定の一貫性を保つか、1台のデバイスのみで自動チェックインを有効にすることをお勧めします。 |

## 関連ドキュメント

-   [自動更新とリアルタイムデータ](./auto-refresh.md)
-   [WebDAV バックアップと自動同期](./webdav-sync.md)
-   [Cloudflare シールドアシスタント](./cloudflare-helper.md)