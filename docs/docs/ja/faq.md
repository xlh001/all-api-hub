# よくある質問

プラグインの使用中によく遭遇する問題を集めました。

## 🔐 認証方法について

### CookieモードとAccess Token方式の違いは何ですか？

プラグインは2種類の認証方法をサポートしています。

| 認証方法 | 特徴 | 適用シーン | 推奨度 |
|---------|------|---------|---------|
| **Access Token** | ✅ 複数アカウント対応<br>✅ 永続的で期限切れなし<br>✅ より安全で安定 | ほとんどの標準的な中継サイト | ⭐⭐⭐⭐⭐ 強く推奨 |
| **Cookie** | ⚠️ シングルアカウント<br>⚠️ 期限切れの可能性あり<br>✅ 互換性が高い | トークンが制限されている特殊なサイト<br>改造された中継サイト | ⭐⭐⭐ 特殊な場合に使用 |

以下の状況に遭遇しない限り、**Access Token 方式の使用を推奨します**。
- サイトがアクセストークンをサポートしていない
- 改造版の中継サイトを使用している
- トークン機能が無効化されている

### 認証方法を切り替えるにはどうすればよいですか？

アカウントを追加する際、アカウントダイアログで対応する認証方法を選択します。
1. 「新規アカウント追加」をクリック
2. サイトアドレスを入力
3. 「認証方法」ドロップダウンボックスで `Access Token` または `Cookie` を選択
4. 「自動識別」をクリック

## 🔧 特殊なサイトに関する問題

<a id="anyrouter-error"></a>
### AnyRouter サイトでエラーが発生した場合、どうすればよいですか？

AnyRouter は改造版の中継サイトであり、標準の Access Token 方式をサポートしていません。

**解決策**：
1. アカウントを追加する際、**Cookie モード**を選択
2. まずブラウザで AnyRouter サイトにログイン
3. その後、プラグインの自動識別機能を使用してアカウントを追加

::: warning 注意
AnyRouter は API を変更しているため、一部の機能が正常に動作しない可能性があります。問題が発生した場合は、サイト管理者に連絡することをお勧めします。
:::

### Sub2API（JWT サイト）はどのように追加しますか？

Sub2API サイトの一般的な特徴：コンソールインターフェースは `/api/v1/*` にあり、**短期 JWT**（`auth_token`）と **リフレッシュトークン（ローテーションあり）** のログイン状態を使用します。コンソールはログイン情報を localStorage に書き込みます。

- `auth_token`：JWT アクセストークン（短期）
- `auth_user`：ユーザー情報（`id` などを含む）
- `refresh_token`：リフレッシュトークン（オプション。アクセストークンの更新に使用され、通常はローテーションします）
- `token_expires_at`：アクセストークンの有効期限タイムスタンプ（ミリ秒、オプション）

プラグインは2つの動作モードをサポートしています。

#### モード 1：コンソールセッションモード（デフォルト/互換性）

このモードでは `refresh_token` はプラグイン内に保存されません。プラグインが残高を自動識別および更新するためには、コンソールの localStorage から `auth_token` / `auth_user` を読み取る必要があるため、**まずブラウザでサイトコンソールにログインする必要があります**。

**追加手順**：
1. ブラウザで対象サイトのコンソールを開き、ログインします（ログインページにリダイレクトされていないことを確認してください）。
2. プラグインを開く → 新規アカウント追加。
3. サイト URL を入力し、「自動識別」をクリック。

**注意点と制限**：
- 同一サイト（同一オリジン）では、1つのブラウザセッション内の localStorage に保存できるログイン状態は1セットのみです。したがって、このモードでは**同一サイトでの複数アカウントの利用体験は非常に悪くなります**。コンソールアカウントを切り替えると localStorage が上書きされ、プラグインもそれに合わせて「ユーザーが切り替わります」。
- 更新時に 401 が発生した場合、プラグインは `auth_token` を再読み込みして再試行します。それでも失敗する場合は、サイトコンソールに再度ログインしてから更新/再識別を行ってください。

#### モード 2：プラグイン管理セッション（複数アカウント、推奨）

有効にすると、プラグインは `refresh_token` を**アカウント固有**の認証情報として保存し（エクスポート/WebDAV バックアップにも含まれます）、各 Sub2API アカウントが独立して JWT を更新できるようになり、**同一サイトでの複数アカウント**をサポートします。

**推奨されるインポート手順（シークレット/プライベートウィンドウ、ローテーションの競合を減らすため）**：
1. シークレット/プライベートウィンドウを開き、対象の Sub2API コンソールにログインします。
2. プラグインでアカウントを新規追加/編集し、「現在ログイン中のアカウントからインポート」（または「自動識別/再識別」）をクリックしてセッション情報をインポートします。
3. フォーム内で「プラグイン管理セッション（複数アカウント）」を有効にし、`refresh_token` が取り込まれていることを確認してから保存します。
4. シークレット/プライベートウィンドウを閉じます（そのサイトの localStorage/Cookie をクリアします）。これにより、コンソールとプラグインが同一の `refresh_token` を並行して更新し、相互に無効化されるのを防ぎます。

**セキュリティに関する注意**：
- `refresh_token` は長期的な認証情報です。このモードを有効にすると、アカウントのエクスポート/WebDAV バックアップと一緒に保存されますので、バックアップファイルと WebDAV 認証情報を適切に管理してください。
- ブラウザが必要とする場合は、拡張機能管理で「シークレット/プライベートウィンドウでの実行を許可」を有効にしてください。

**トラブルシューティング**：
- refresh_token が無効/ローテーション済みと表示された場合は、上記の手順に従って再インポート（または新しい `refresh_token` を手動で貼り付け）してから再試行してください。

**その他の既知の制限**：
- **アクセストークン（JWT）** モードのみをサポートしており、Cookie 認証はサポートしていません。
- サイトのチェックイン機能は現在サポートされていません（チェックイン検出は自動的にオフになります）。
- 現在のバージョンでは主に**残高/クォータ**を同期します。「今日の使用量/収益」などの統計は 0 になる可能性があります。

### 自動識別が失敗した場合、どうすればよいですか？

自動識別が失敗した場合は、以下の方法を試してください。

1. **認証方法の切り替え**：Access Token から Cookie モードへの切り替えを試す
2. **手動追加**：自動識別が失敗した後、以下の情報を手動で入力
   - ユーザー名
   - ユーザーID
   - アクセストークン
   - チャージ比率
3. **ログイン状態の確認**：対象サイトにブラウザでログインしていることを確認
4. **サイトの互換性の確認**：サイトがサポートされているプロジェクトに基づいているか確認（下記参照）

### どのサイトが互換性がない可能性がありますか？

サイトが深い二次開発を行い、重要なインターフェース（例：`/api/user`）を変更した場合、プラグインが正常に動作しない可能性があります。

一般的な非互換の状況：
- ユーザー情報インターフェースが変更されている
- アクセストークン機能が無効化されている
- 認証方法がカスタム化されている
- API応答形式が変更されている

## 🐛 機能とバグについて

### 機能上の問題やバグに遭遇した場合、どうすればよいですか？

1. **Issue の検索**：[GitHub Issues](https://github.com/qixing-jk/all-api-hub/issues) にアクセスし、同じ問題がないか検索
2. **最新バージョンの使用**：
   - ストア版の更新は遅いため、GitHub Release 版の使用を推奨します
   - または main ブランチの開発バージョンを直接使用

### 最新バージョンを取得するにはどうすればよいですか？

プラグインは複数のプラットフォームで公開されており、更新速度に違いがあります。

| プラットフォーム | 更新速度 | バージョン取得 |
|------|---------------|---------|
| **GitHub Releases** | ⚡ 最速 | [ダウンロードへ](https://github.com/qixing-jk/all-api-hub/releases) |
| **Chrome Web Store** | 🐌 遅め（3〜5日間の審査） | [インストールへ](https://chromewebstore.google.com/detail/lapnciffpekdengooeolaienkeoilfeo) |
| **Edge Add-ons** | 🐌 遅め（3〜5日間の審査） | [インストールへ](https://microsoftedge.microsoft.com/addons/detail/pcokpjaffghgipcgjhapgdpeddlhblaa) |
| **Firefox Add-ons** | ⚡ 速い（数時間の審査） | [インストールへ](https://addons.mozilla.org/firefox/addon/{bc73541a-133d-4b50-b261-36ea20df0d24}) |

::: tip 提案
修正済みのバグに遭遇した場合は、GitHub Releases から最新バージョンをダウンロードして手動でインストールすることをお勧めします。
:::

## ⚙️ 機能の使用に関する問題

### WebDAV バックアップはどのように使用しますか？

WebDAV バックアップは、複数のデバイス間でデータを同期するのに役立ちます。

1. **WebDAV の設定**：
   - 「設定」→「WebDAV バックアップ」を開く
   - WebDAV サーバーアドレス（完全なURL）を入力
   - ユーザー名とパスワードを入力
   
2. **同期ポリシーの選択**：
   - `マージ`（推奨）：ローカルデータとリモートデータをインテリジェントに統合
   - `アップロードのみ`：ローカルデータのみをサーバーにアップロード
   - `ダウンロードのみ`：サーバーからデータのみをダウンロード

3. **自動同期の有効化**：
   - 「自動同期を有効にする」にチェックを入れる
   - 同期間隔を設定（デフォルト 3600秒/1時間）

::: tip 推奨サービス
- [堅果雲 (Jianguoyun)](https://www.jianguoyun.com/)（国内アクセスが速い）
- Nextcloud（セルフホスト）
- Synology NAS（群暉）
:::

### CherryStudio / New API にエクスポートするにはどうすればよいですか？

クイックエクスポート機能を使用すると、サイト設定をワンクリックで他のプラットフォームにインポートできます。

**設定手順**：

1. **New API の場合**：
   - 「設定」→「基本設定」を開く
   - New API サーバーアドレスを設定
   - 管理者トークン（Admin Token）を入力
   - ユーザーIDを入力

2. **CherryStudio の場合**：
   - 追加の設定は不要
   - CherryStudio が実行中であることを確認

**エクスポート手順**：

1. 「キー管理」ページに移動
2. エクスポートしたいサイトを見つける
3. 操作メニューをクリック
4. 「CherryStudio にエクスポート」または「New API にエクスポート」を選択

::: info インテリジェント検出
New API へのエクスポート時、プラグインは同じチャネルが既に存在するかどうかを自動的に検出し、重複追加を防ぎます。
:::

より完全なエクスポートと統合の説明については、[サイト設定のクイックエクスポート](./quick-export.md) を参照してください。CLIProxyAPI 管理インターフェースとの連携を希望する場合は、[CLIProxyAPI 統合](./cliproxyapi-integration.md) を参照してください。

### サイトのチェックイン機能はどのように使用しますか？

一部の中継サイトでは、毎日のチェックインによる報酬獲得をサポートしています。

1. **チェックイン検出の有効化**：
   - アカウントを編集
   - 「チェックイン検出を有効にする」にチェックを入れる
   
2. **カスタムチェックイン URL**（オプション）：
   - サイトのチェックインページが標準パスではない場合
   - 「カスタムチェックイン URL」を入力できます
   - 「カスタムチャージ URL」（オプション）を入力

3. **チェックインの実行**：
   - チェックインが必要なアカウントにはチェックインアイコンが表示されます
   - アカウントカード上のチェックインボタンをクリック
   - チェックインページが自動的に開きます

### アカウントの並べ替えをカスタマイズするにはどうすればよいですか？

プラグインは、複数の並べ替え方法の優先度設定をサポートしています。

1. **並べ替え設定への移動**：
   - 「設定」→「並べ替え優先度設定」を開く
   
2. **優先度の調整**：
   - 並べ替え条件をドラッグして優先度を調整
   - チェック/チェック解除で条件を有効/無効化
   
3. **利用可能な並べ替え条件**：
   - 📌 現在のサイトをトップに固定
   - 🏥 健康状態による並べ替え（エラー > 警告 > 不明 > 正常）
   - ✅ チェックインが必要なアカウントをトップに固定
   - 🔗 カスタムチェックイン URL を持つアカウントをトップに固定
   - 📊 ユーザー定義フィールドによる並べ替え（残高/消費/収益/名前）

各並べ替えルールの詳細な意味と設定例については、[並べ替え優先度設定](./sorting-priority.md) を参照してください。

### 自動更新はどのように設定しますか？

自動更新により、アカウントデータを最新の状態に保つことができます。

1. **自動更新の有効化**：
   - 「設定」→「自動更新」を開く
   - 「定期的な自動更新を有効にする」にチェックを入れる
   
2. **更新間隔の設定**：
   - デフォルト：360秒（6分）
   - 最小：60秒（1分）
   - サイト数に応じて調整
   
3. **その他のオプション**：
   - ✅ プラグインを開いたときに自動更新
   - ✅ 健康状態を表示

::: warning 注意
更新間隔が短すぎると、頻繁なリクエストが発生する可能性があるため、60秒以上に設定することをお勧めします。
:::

### 残高履歴（Balance History）はどのように使用しますか？

残高履歴は、アカウント残高の長期的な変化と日々の収支傾向を確認するために使用されます。有効にすると、ローカルに**日次で集計されたスナップショット**が記録され、グラフで表示されます。

**記録内容（各アカウントにつき1日最大1件）**：

- 残高/クォータ：`quota`
- 今日の収益：`today_income`（チャージ/システムログ統計から）
- 今日の支出：`today_quota_consumption`（消費ログ統計から）
- 記録時間：`capturedAt`
- ソース：`source`（更新 / 日次終了時取得）

**記録方法**：

1. **更新駆動**：アカウントの更新が成功した後、当日のスナップショットが更新されます。このプロセスは「今日の収支を表示」スイッチに**従い**、残高履歴のためにログを強制的に追加取得することはありません。
2. **日次終了時取得（オプション）**：有効にすると、毎日 `23:55` 頃にバックグラウンドで一度取得が行われ、当日の収益/支出データを可能な限り補完するために**今日の収支を強制的に含めます**。

**前提条件（重要）**：

- 「今日の収支を表示」をオフにすると、更新駆動による収益/支出フィールドは空になります。
- 収益/支出履歴を記録したい場合は、以下のいずれかを有効にしてください。
  - 「今日の収支を表示」（更新時に今日の収支を計算）
  - 「日次終了時取得」（1日1回、今日の収支を強制的に取得）

**制限と説明**：

- **ベストエフォート**：ブラウザのスリープ、ネットワーク中断、またはサイトの制限により、特定の日付が欠落する可能性があり、グラフには途切れ/空白が表示されます。
- **履歴の遡及なし**：過去の日付を補完するために履歴ログを遡って確認することはありません（大量のネットワークリクエストの発生を避けるため）。
- **保持とクリーンアップ**：直近 N 日間（デフォルト 365日）のみ保持され、書き込み時にウィンドウを超えたスナップショットは自動的にクリーンアップされます。ページ内で手動で「クリーンアップ」を実行することもできます。
- **ローカルストレージ**：残高履歴はローカルにのみ保存されます（現在のバージョンでは、インポート/エクスポートや WebDAV 同期と一緒に移行されません）。

## 📱 モバイルでの使用

### スマートフォンで使うにはどうすればよいですか？

プラグインはモバイルデバイスでの使用をサポートしています。

**Android デバイス**：
1. [Kiwi Browser](https://play.google.com/store/apps/details?id=com.kiwibrowser.browser) をインストール（推奨）
   - Chrome 拡張機能と完全に互換性あり
   - すべての機能をサポート
   
2. または Firefox for Android をインストール
   - Firefox Add-ons からインストール

**iOS デバイス**：
- 現在はサポートされていません（iOS の制限）

### モバイルでの使用に関する推奨事項

1. **サイドバーモードの使用**：スマートフォンの画面により適しています
2. **自動更新の有効化**：頻繁な手動更新を避ける
3. **WebDAV 同期の設定**：PCとスマートフォン間でデータを同期

## 🔒 データセキュリティ

### データはどこに保存されますか？

- **ローカルストレージ**：すべてのデータはブラウザのローカルストレージに保存されます
- **完全オフライン**：プラグインのコア機能はインターネット接続を必要としません
- **データはアップロードされません**：いかなる第三者サーバーにもデータはアップロードされません

### データは失われますか？

定期的なデータバックアップを推奨します。

1. **JSON エクスポート**：
   - 「設定」→「データとバックアップ」に移動
   - 「データのエクスポート」をクリック
   - JSONファイルを保存

2. **WebDAV 同期**（推奨）：
   - クラウドに自動バックアップ
   - 複数デバイスでの同期をサポート

## 🆘 その他の問題

### サイトの重複検出とは何ですか？

サイトを追加する際、プラグインは同じサイトが既に存在するかどうかを自動的に検出します。
- サイトURLに基づいて判断
- 既に存在する場合は、警告が表示され、迅速な変更が許可されます
- 同じサイトの重複追加を回避

### 健康状態とはどういう意味ですか？

健康状態はアカウントの利用可能性を示します。

| 状態 | アイコン | 意味 |
|------|------|------|
| 🟢 正常 | Healthy | アカウントは正常に動作しています |
| 🟡 警告 | Warning | 残高不足または注意が必要 |
| 🔴 エラー | Error | API呼び出しの失敗またはアカウントの異常 |
| ⚪ 不明 | Unknown | まだ検出されていないか、状態を取得できません |

### プラグインはトラフィックを消費しますか？

- アカウントデータを更新するときにのみサイトAPIにアクセスします
- リクエスト量は非常に少ないです（各サイトにつき約数KB）
- WiFi環境での自動更新の使用を推奨します

### コードに貢献するにはどうすればよいですか？

プルリクエストの提出を歓迎します。
1. プロジェクトリポジトリをフォーク
2. 機能ブランチを作成
3. コードをコミット
4. プルリクエストを送信

詳細：[CONTRIBUTING.md](https://github.com/qixing-jk/all-api-hub/blob/main/CONTRIBUTING.md)

---

## 📚 関連ドキュメント

- [使用チュートリアル](./get-started.md)
- [GitHub リポジトリ](https://github.com/qixing-jk/all-api-hub)
- [問題のフィードバック](https://github.com/qixing-jk/all-api-hub/issues)
- [更新履歴](./changelog.md)

::: tip 答えが見つからない場合
上記の内容で問題が解決しない場合は、[GitHub Issues](https://github.com/qixing-jk/all-api-hub/issues) で質問してください。
:::