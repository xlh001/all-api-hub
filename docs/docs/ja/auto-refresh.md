# 自動更新とリアルタイムデータ

> アカウント残高、使用量、モデルリストを常に最新の状態に保ち、手動で「更新」を毎回クリックする必要はありません。バックグラウンドタイマーとポップアップオープン時の即時更新という二重の戦略を提供します。

## 機能概要

- **バックグラウンドタイマー**：`autoRefreshService` によって駆動され、ブラウザのバックグラウンドで定期的にアカウント更新APIを呼び出します。10秒から数時間までのカスタム間隔をサポートします。
- **開くと即時更新**：オプションの「プラグインを開いたときに自動更新」スイッチは、バックグラウンドタイマーを無効にするが、データ同期を確保したいシナリオに適しています。
- **最小間隔保護**：`minInterval` を個別に設定し、頻繁すぎる手動更新がサイトのリスク管理をトリガーするのを防ぎます。
- **即時更新**：いつでも「今すぐ更新」を実行し、すべてのサイトの最新の残高/クォータを即座に取得します。

## 前提条件

1.  少なくとも1つのサイトアカウントを正常に追加済みであること。
2.  ブラウザが拡張機能の実行を維持していること（モバイルのKiwi/Firefoxでも可能ですが、ブラウザがシステムによって強制終了されていないことを確認する必要があります）。
3.  サイトにCloudflare保護が存在する場合、まず [Cloudflare過盾アシスタント](./cloudflare-helper.md) を参照して検証を完了してください。

## 設定方法

1.  プラグインを開く → **設定**。
2.  **「基本設定 → 自動更新」** タブを選択し、`RefreshSettings` パネルに入ります。

## 主要な設定項目

| オプション | 説明 |
| ---------- | ---- |
| **自動更新を有効にする** | バックグラウンドタイマーのオン/オフを制御します。オフにすると手動更新のみが残ります。 |
| **更新間隔（秒）** | タイマーの実行周期で、`accountAutoRefresh.interval` に対応します。10秒未満の入力はブロックされ、警告が表示されます。 |
| **プラグインを開いたときに自動更新** | ブラウザアイコンをクリックしてポップアップを開くたびに、`refreshNow()` を自動的に1回実行します。 |
| **最小更新間隔（秒）** | ユーザーが「更新」ボタンを頻繁にクリックするのを制限します。デフォルトは60秒です。 |
| **デフォルトに戻す** | `resetAutoRefreshConfig()` を呼び出し、360秒/60秒/有効化の状態にリセットします。 |

## 動作原理

1.  ユーザーが設定を保存すると、`UserPreferencesContext` を介して `accountAutoRefresh` がローカルの環境設定に書き込まれます。
2.  バックグラウンドページが `updateAutoRefreshSettings` メッセージを受信し、`autoRefreshService.setupAutoRefresh()` を呼び出します。
    -   スイッチがオフであるか、設定が不完全な場合はタイマーを停止します。
    -   それ以外の場合は、間隔に基づいて `setInterval` を作成し、定期的に `accountStorage.refreshAllAccounts(false)` を実行します。
3.  更新結果（成功/失敗）は `AUTO_REFRESH_UPDATE` メッセージを介してフロントエンドにブロードキャストされます。ポップアップが開いていない場合は、サイレントに無視されます。

## 推奨戦略

-   **高頻度チェック**：主要なアカウントは300～600秒に設定し、残高アラートがタイムリーに行われるようにすることをお勧めします。
-   **低頻度 + 開いたときに更新**：サイトのレート制限を心配する場合は、バックグラウンドタイマーをオフにし、「開くと即時更新」のみを保持できます。
-   **通知との連携**：ブラウザ自身の通知やスクリプトと連携し、`AUTO_REFRESH_UPDATE` をリッスンして二次開発のアラートを実装します。

## よくある質問

| 問題 | 解決策 |
| ---- | ------ |
| 定期更新がトリガーされない | ブラウザがシステムによって休止状態になった可能性があります。拡張機能を再度開くか、手動で「今すぐ更新」をクリックしてください。必要に応じて、間隔を短くしてみてください。 |
| 頻繁にCloudflareのレート制限がトリガーされる | 更新間隔を適切に長くし、[Cloudflare過盾アシスタント](./cloudflare-helper.md) が正常にポップアップ検証を行えることを確認してください。 |
| 更新が失敗し、401/403と表示される | ログイン状態が無効になっています。ブラウザで該当するサイトに再度アクセスし、プラグインを更新してください。 |
| 複数デバイスの競合 | [WebDAVバックアップと自動同期](./webdav-sync.md) を活用してアカウントデータを一元化し、同じサイトの重複更新を避けることをお勧めします。 |

## 関連ドキュメント

-   [Cloudflare過盾アシスタント](./cloudflare-helper.md)
-   [自動チェックイン](./auto-checkin.md)
-   [WebDAVバックアップと自動同期](./webdav-sync.md)