# 自動更新とリアルタイムデータ

> アカウント残高、使用量、モデルリストを常に最新の状態に保ち、手動で「更新」をクリックする手間を省きます。バックグラウンドタイマーとポップアップオープン時の即時更新という二重の戦略を提供します。

## 機能概要

- **バックグラウンドタイマー**：`autoRefreshService` によって駆動され、ブラウザのバックグラウンドで定期的にアカウント更新APIを呼び出します。10秒から数時間のカスタム間隔をサポートします。
- **オープン時の即時更新**：オプションの「プラグインオープン時に自動更新」スイッチは、バックグラウンドタイマーをオフにしているが、データの同期を保証したいシナリオに適しています。
- **最小間隔保護**：`minInterval` を個別に設定することで、頻繁すぎる手動更新がサイトのレート制限に引っかかるのを防ぎます。
- **即時更新**：「今すぐ更新」をいつでも実行し、すべてのサイトの最新残高/額度をすぐに取得します。

## 前提条件

1. 少なくとも1つのサイトアカウントが正常に追加されていること。
2. ブラウザが拡張機能の実行を維持していること（モバイルのKiwi/Firefoxでも可能ですが、ブラウザがシステムによって終了されていないことを確認してください）。
3. サイトにCloudflareの保護がある場合は、まず[Cloudflare シールドアシスタント](./cloudflare-helper.md)を参照して検証を完了してください。

## 設定アクセス

1. プラグインを開く → **設定**。
2. **「基本設定 → 自動更新」** タブを選択し、`RefreshSettings` パネルに入ります。

## 主要設定項目

| オプション | 説明 |
|------|------|
| **自動更新を有効にする** | バックグラウンドタイマーのオン/オフを制御します。オフにすると手動更新のみが残ります。 |
| **更新間隔（秒）** | タイマーの実行周期。`accountAutoRefresh.interval` に対応します。10秒未満の入力はブロックされ、警告が表示されます。 |
| **プラグインオープン時に自動更新** | ブラウザアイコンをクリックしてポップアップを開くたびに、`refreshNow()` を自動的に1回実行します。 |
| **最小更新間隔（秒）** | ユーザーが「更新」ボタンを頻繁にクリックするのを制限します。デフォルトは60秒です。 |
| **デフォルトに戻す** | `resetAutoRefreshConfig()` を呼び出し、360秒/60秒/有効の状態に戻します。 |

## 動作原理

1. ユーザーが設定を保存すると、`UserPreferencesContext` を介して `accountAutoRefresh` がローカル設定に書き込まれます。
2. バックグラウンドページが `updateAutoRefreshSettings` メッセージを受信し、`autoRefreshService.setupAutoRefresh()` を呼び出します。
   - スイッチがオフになっているか、設定が不完全な場合はタイマーを停止します。
   - そうでない場合は、間隔に基づいて `setInterval` を作成し、周期的に `accountStorage.refreshAllAccounts(false)` を実行します。
3. 更新結果（成功/失敗）は `AUTO_REFRESH_UPDATE` メッセージを介してフロントエンドにブロードキャストされます。ポップアップが開いていない場合はサイレントに無視されます。

## 推奨戦略

- **高頻度チェック**：コアアカウントは300〜600秒に設定し、残高アラートがタイムリーに届くようにすることをお勧めします。
- **低頻度 + 開いて更新**：サイトのレート制限が心配な場合は、バックグラウンドタイマーをオフにし、「開いて即時更新」のみを残すことができます。
- **通知との連携**：ブラウザ自身の通知やスクリプトと連携し、`AUTO_REFRESH_UPDATE` をリッスンして二次開発のアラートを実装します。

## よくある質問

| 問題 | 解決策 |
|------|----------|
| 定期更新がトリガーされない | ブラウザがシステムによってスリープ状態になった可能性があります。拡張機能を再度開くか、手動で「今すぐ更新」をクリックしてください。必要に応じて間隔を短くすることを試してください。 |
| Cloudflareのレート制限が頻繁にトリガーされる | 更新間隔を適切に長くし、[Cloudflare シールドアシスタント](./cloudflare-helper.md) が正常にポップアップ検証できることを確認してください。 |
| 更新に失敗し、401/403と表示される | ログイン状態が無効になっています。ブラウザで対応するサイトに再度アクセスし、プラグインを更新してください。 |
| 複数デバイスの競合 | [WebDAV バックアップと自動同期](./webdav-sync.md) を使用してアカウントデータを統合し、同じサイトの重複更新を避けることをお勧めします。 |

## 関連ドキュメント

- [Cloudflare シールドアシスタント](./cloudflare-helper.md)
- [自動チェックイン](./auto-checkin.md)
- [WebDAV バックアップと自動同期](./webdav-sync.md)
- [権限管理（オプション権限）](./permissions.md)