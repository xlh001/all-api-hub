# New API チャネル管理

> 🧪 この機能は現在ベータ段階にあり、最も頻繁に行われるチャネル運用アクション（サイト構築、パラメータ調整、同期）をプラグイン内に集約し、New API のバックエンドを行き来する手間を省くことを目的としています。

## 機能概要

- 📋 **チャネルの概要とフィルタリング**：すべてのチャネルの名前、タイプ、グループ、優先度、重み、ステータスを一目で確認でき、キーワード検索と複数タグによるフィルタリングをサポートします。
- ✏️ **クイック作成 / 編集**：ポップアップフォームは New API のフィールド定義を踏襲しており、モデルリスト、グループ、優先度、重み、ステータスを一度に設定できます。
- 🔄 **シングルチャネル同期**：モデル同期のデバッグ時に、リスト内で指定されたチャネルに対して直接「このチャネルを同期」をトリガーでき、一括同期を補完します。
- 🗑️ **安全な削除**：一括選択後に削除をトリガーする前に再度確認を求められ、本番チャネルの誤削除を防ぎます。
- 📦 **シームレスなエクスポート**：キー管理と連携し、作成後すぐに CherryStudio、New API、または CC Switch にエクスポートできます。

## 前提条件

| 設定項目 | 説明 |
|--------|------|
| **New API ベースURL** | アクセス可能なバックエンドアドレス。例： `https://example.com` |
| **管理者トークン** | チャネルの読み書き権限を持つ管理者トークン |
| **管理者ユーザーID** | トークンに対応するユーザーID |

> プラグインで **設定 → 基本設定 → New API 統合設定** を開き、上記情報を入力して保存します。設定が不足している場合、チャネル管理ページには「設定不足」のヒントが表示されます。

## 機能ページへのアクセス方法

1.  拡張機能のポップアップを開き、左側の **「設定」** をクリックします。
2.  設定ページの上部タイトル下にある **「New API チャネル管理（ベータ）」** を選択するか、基本設定内の **「チャネル管理」** ボタンを直接クリックします。
3.  設定に誤りがなければ、リモートチャネルリストが自動的にロードされます。

## チャネルリストビュー

- ![New API 渠道管理界面](../static/image/en/new-api-channel-manage.png)

-   **検索ボックス**：名前 / ベースURL / グループキーワードによるあいまい検索をサポートします。
-   **ステータスフィルター**：右上の `ステータス` フィルターで、有効、手動一時停止、または自動無効化されたチャネルを素早く確認できます。
-   **カスタム列**：列セレクターを使用して、ベースURL、グループ、優先度などの列を表示するかどうかを制御します。
-   **一括操作バー**：行の前にチェックを入れると、一括削除が有効になります。

## チャネルの作成または編集

1.  右上の **「新規チャネル」** をクリックするか、行末のメニューから **「編集」** を選択します。
2.  ポップアップウィンドウで以下を入力します。
    -   **基本情報**：名前、タイプ、APIキー、ベースURL。
    -   **モデルリスト**：すべて選択、選択解除、クリアをサポートし、カスタムモデルを手動で入力することもできます。
    -   **ユーザーグループ**：New API のバックエンドからグループを自動的に読み込みますが、カスタム設定も可能です。
    -   **詳細設定**：優先度（priority）、重み（weight）、ステータス（有効/無効）。
3.  **「保存」** をクリックすると、システムは New API の `POST/PUT /api/channel` インターフェースを呼び出し、成功するとリストが自動的に更新されます。

### フィールド検証

-   チャネル名とAPIキーは必須です（編集時には要件に応じて緩和される場合があります）。
-   一部のタイプ（例：火山、Suno）ではベースURLの提供が必要です。
-   検証に失敗したフィールドは理由が提示され、送信に失敗した場合は右上にトーストが表示されます。

## シングルチャネル同期

**New API モデル同期** と連携してデバッグを行っている場合、リスト内の行末にある **「同期」** ボタンをクリックすると、現在のチャネルに対してのみモデルのリダイレクト生成と再試行がトリガーされ、迅速な検証に役立ちます。

## チャネルの削除

1.  削除したいチャネルにチェックを入れ、**「削除」** をクリックします。
2.  ポップアップウィンドウで確認後、`DELETE /api/channel/{id}` が呼び出されます。
3.  エラー（権限不足など）が返された場合、インターフェースにはバックエンドから返された詳細情報が表示されます。

## 高度なヒント

-   **モデルホワイトリストとの連携**：まずモデル同期ページでホワイトリストを設定し、その後チャネルページに戻って個別に同期することで、新しいチャネルが必要なモデルのみを含むようにできます。
-   **優先度と重み**：
    -   `priority` が低いほど、呼び出し順序は早くなります。
    -   `weight` は同じ優先度のチャネルの負荷分散に使用され、数値が大きいほどヒットする確率が高くなります。
-   **一括エクスポート**：チャネルを保存した後、**キー管理 → エクスポート** パネルから CherryStudio / CC Switch にワンクリックでプッシュでき、重複入力を回避できます。

## よくある質問

| 問題 | 解決策 |
|------|----------|
| チャネルリストが空です | New API の設定が完全に記入されているか、またはネットワークがバックエンドにアクセス可能かを確認してください。 |
| 保存時に401/403エラーが発生します | 管理者トークンがチャネルの書き込み権限を持っていることを確認し、必要に応じてトークンを再生成してください。 |
| モデル/グループリストが空です | プラグインは手動入力を引き続き許可します。`設定 → New API 統合` で設定を再保存してから再試行してください。 |
| 同期をクリックしても応答がありません | ブラウザがバックグラウンドスクリプトを無効にしていないか、またはモデル同期ページでグローバル同期機能が正常に動作しているかを確認してください。 |

## 関連ドキュメント

-   [New API モデルリスト同期](./new-api-model-sync.md)：チャネルモデルを自動で一括同期します。
-   [クイックエクスポートと統合](./get-started.md#quick-export-sites)：チャネルをダウンストリームアプリケーションにプッシュする方法を学びます。
