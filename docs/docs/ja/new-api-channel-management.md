# New API チャネル管理

> 🧪 この機能は現在ベータ段階にあり、最も頻繁に使用されるチャネル運用アクション（サイト構築、パラメータ調整、同期）をプラグイン内に凝縮し、New API の管理画面を行き来する手間を省くことを目的としています。

## 機能概要

- 📋 **チャネルの概要とフィルタリング**：すべてのチャネルの名前、タイプ、グループ、優先度、重み、およびステータスを一目で確認でき、キーワード検索とマルチタグフィルタリングに対応しています。
- ✏️ **クイック作成 / 編集**：ポップアップフォームは New API のフィールド定義を踏襲しており、モデルリスト、グループ、優先度、重み、およびステータスを一度に設定できます。
- 🔄 **シングルチャネル同期**：モデル同期のデバッグ時に、リスト内で指定されたチャネルに対して直接「このチャネルを同期」をトリガーでき、一括同期を補完します。
- 🗑️ **安全な削除**：一括選択後、削除をトリガーする前に再度確認が行われ、本番チャネルの誤削除を防ぎます。
- 📦 **シームレスなエクスポート**：キー管理と連携し、作成後すぐに CherryStudio、New API、または CC Switch にエクスポートできます。

## 前提条件

| 設定項目 | 説明 |
|--------|------|
| **New API ベース URL** | アクセス可能な管理画面アドレス。例: `https://example.com` |
| **管理者トークン** | チャネルの読み書き権限を持つ Admin Token |
| **管理者ユーザー ID** | トークンに対応するユーザー ID |

> プラグイン内で **設定 → 基本設定 → New API 統合設定** を開き、上記情報を入力して保存します。設定が不足している場合、チャネル管理ページには「設定不足」の警告が表示されます。

## 機能ページへのアクセス方法

1. 拡張機能のポップアップを開き、左側の **「設定」** をクリックします。
2. 設定ページの上部タイトル下にある **「New API チャネル管理（Beta）」** を選択するか、基本設定内の **「チャネルを管理」** ボタンを直接クリックします。
3. 設定に誤りがなければ、リモートチャネルリストが自動的にロードされます。

## チャネルリストビュー

- ![New API チャネル管理画面](./static/image/new-api-channel-manage.png)

- **検索ボックス**：名前 / ベース URL / グループのキーワードによるあいまい検索に対応しています。
- **ステータスフィルタ**：右上隅の `ステータス` フィルターを使用して、有効、手動一時停止、または自動無効化されたチャネルをすばやく確認できます。
- **カスタム列**：列セレクターを通じて、ベース URL、グループ、優先度などの列を表示するかどうかを制御します。
- **一括操作バー**：行の前にチェックを入れると、一括削除が有効になります。

## チャネルの作成または編集

1. 右上隅の **「新規チャネルを追加」** をクリックするか、行末のメニューで **「編集」** を選択します。
2. ポップアップで以下を入力します。
   - **基本情報**：名前、タイプ、API Key、ベース URL。
   - **モデルリスト**：すべて選択、選択解除、クリアに対応しており、カスタムモデルを手動で入力することもできます。
   - **ユーザーグループ**：New API 管理画面のグループを自動的に読み取ります。カスタム設定も可能です。
   - **高度な設定**：優先度（priority）、重み（weight）、ステータス（有効/無効）。
3. **「保存」** をクリックすると、システムは New API の `POST/PUT /api/channel` インターフェースを呼び出し、成功後にリストが自動的に更新されます。

### フィールド検証

- チャネル名と API Key は必須入力です（編集時には要件に応じて緩和される場合があります）。
- 一部のタイプ（例：火山、Suno）では、ベース URL の提供が必要です。
- 検証に失敗したフィールドは理由が表示されます。送信に失敗した場合、右上隅にトースト通知が表示されます。

## シングルチャネル同期

**New API モデル同期** と連携してデバッグを行っている場合、リスト内の行末にある **「同期」** ボタンをクリックすると、現在のチャネルに対してのみモデルのリダイレクト生成と再試行がトリガーされ、迅速な検証に役立ちます。

## チャネルの削除

1. 削除したいチャネルにチェックを入れ、**「削除」** をクリックします。
2. ポップアップで確認後、`DELETE /api/channel/{id}` が呼び出されます。
3. エラー（例：権限不足）が返された場合、インターフェースにはバックエンドから返された詳細情報が表示されます。

## 高度なテクニック

- **モデルホワイトリストとの連携**：まずモデル同期ページでホワイトリストを設定し、その後チャネルページに戻って個別に同期することで、新しいチャネルに必要なモデルのみが含まれることを保証できます。
- **[優先度と重み](https://docs.newapi.pro/zh/docs/support/faq#-%E6%B8%A3%E9%81%93%E9%85%8D%E7%BD%AE%E9%97%AE%E9%A2%98)**：
  - 優先度（`Priority`）：数字が大きいほど優先度が高く、優先度の高いチャネルが優先的に使用されます。
  - 重み（`Weight`）：同じ優先度のチャネル内で、重みの比率に応じてリクエストが分配されます。
- **一括エクスポート**：チャネルを保存した後、**キー管理 → エクスポート** パネルから CherryStudio / CC Switch にワンクリックでプッシュでき、重複入力を避けることができます。

## よくある質問

| 問題 | 解決策 |
|------|----------|
| チャネルリストが空である | New API の設定が完全に記入されているか、ネットワークが管理画面にアクセス可能かを確認してください。 |
| 保存時に 401/403 エラーが発生する | 管理者トークンがチャネルの書き込み権限を持っていることを確認し、必要に応じてトークンを再生成してください。 |
| モデル/グループリストが空である | プラグインは手動入力を引き続き許可します。`設定 → New API 統合` で設定を再保存してから再試行してください。 |
| 同期をクリックしても応答がない | ブラウザがバックグラウンドスクリプトを無効にしていないか確認するか、モデル同期ページでグローバル同期機能が正常に動作していることを確認してください。 |

## 関連ドキュメント

- [New API モデルリスト同期](./new-api-model-sync.md)：チャネルモデルを自動で一括同期します。
- [クイックエクスポートと統合](./get-started.md#quick-export-sites)：チャネルを下流アプリケーションにプッシュする方法を理解します。