# モデルリダイレクト（Model Redirect）

> New API のチャネルに対し、「標準モデル → 実際モデル」のマッピングを自動生成します。これにより、ダウンストリームでは統一されたモデル名（例: `gpt-4o`）を呼び出すだけで、システムが各アップストリームの中継地点が実際に提供するモデルに自動的にルーティングします。

## 機能概要

- **統一されたモデル呼び出しエントリポイント**
  - New API では、「標準モデル名」（例: `gpt-4o`、`claude-4.5-haiku`）のセットを統一して使用できます。
  - モデルリダイレクトは、それらを各チャネルで実際に利用可能なモデル名にマッピングします。
- **マッピングの自動生成**
  - チャネルが報告する `models` リストと「標準モデルリスト」のセットに基づいて、最適な対応関係を自動で計算します。
  - チャネルごとの増分マージをサポートし、手動で設定した一部のマッピングは保持されます。
- **モデル同期およびチャネル管理との併用**
  - 通常、**New API モデルリスト同期** および **New API チャネル管理** と組み合わせて使用されます。
    - モデル同期は、アップストリームで利用可能なモデルリストを New API に取り込む役割を担います。
    - モデルリダイレクトは、これらのモデルを「標準モデル」のセットに合わせる役割を担います。

## 前提条件

- プラグインで **New API 統合設定** が完了していること：
  - **管理者 URL**、**Admin Token**、**ユーザー ID** が入力されていること。
- New API に少なくとも1つの有効なチャネルが存在し、そのチャネルの `models` フィールドに利用可能なモデルリストが含まれていること。
- モデル同期が一度完了していること（推奨）、これによりチャネル内のモデルリストが最新であることが保証されます。

## 設定エントリ

1. プラグインを開く → **設定** ページに移動します。
2. **「New API」** タブに切り替えます。
3. ページの下部にある **「モデルリダイレクト」** エリア（`id="model-redirect"`）を見つけます。
4. 次の項目が表示されます。
   - 有効化スイッチ
   - 標準モデル複数選択リスト
   - 「今すぐマッピングを再生成」ボタン

## 主要設定項目

- **モデルリダイレクトの有効化**
  - 有効にすると、モデルリダイレクトアルゴリズムは、手動で「再生成」をクリックしたとき、または特定の同期プロセス中に呼び出されます。
- **標準モデルリスト**
  - 一般的なベンダーの標準モデルが組み込まれています。例：
    - OpenAI シリーズ：`gpt-4o`、`gpt-4o-mini`、`o3`、`o3-mini` など。
    - Anthropic / Google / Mistral / DeepSeek / 通义千问などの主要モデル。
  - 必要に応じて追加/削除したり、カスタムの標準モデル名を手動で入力したりできます。
- **今すぐマッピングを再生成**
  - ボタンをクリックすると、プラグインは次の処理を実行します。
    - すべてのチャネルリストを取得します（手動/自動で無効化されたチャネルは除外されます）。
    - 各チャネルに対して「標準モデル → 実際モデル」のマッピングテーブルを計算します。
    - 結果を既存の `model_mapping` とマージして書き戻します（新しいキーが古い値を上書きします）。

## 動作原理（概要）

1. ユーザー設定からモデルリダイレクト設定を読み取ります。
   - 有効化されていない場合、「機能はオフです」と表示して直接終了します。
2. 標準モデルセットを計算します。
   - カスタム設定がない場合、組み込みの標準モデル全体が使用されます。
3. New API 管理インターフェースを介してすべてのチャネルリストを取得します。
4. 各チャネルに対して：
   - チャネルの `models` フィールドを解析して、実際のモデルリストを抽出します。
   - 各標準モデルに対して多段階マッチングを実行します：
     - チャネル自体が同じ名前のモデルを含んでいる場合、スキップします（リダイレクトは不要です）。
     - そうでない場合、統一された「モデル正規化ルール」（`renameModel`）に基づいて、最も近い候補の実際のモデルを探します。
     - 候補のセットから、まだ割り当てられていない実際のモデルを選択し、`standardModel -> actualModel` のマッピングを書き込みます。
   - 新しいマッピングとチャネル既存の `model_mapping` JSON をマージして書き戻します。
5. 更新が成功したチャネル数と失敗原因を集計し、UI にトーストで表示します。

## 典型的な使用シナリオ

- **OpenAI互換モデル名の統一**
  - 異なるアップストリームでは、わずかに異なるモデル名（例: プレフィックス/サフィックス付き）が使用される場合があります。
  - モデルリダイレクトを使用すると、ダウンストリームアプリケーションで常に統一された名前（例: `gpt-4o`）を使用でき、New API がマッピングに基づいて実際のモデルにルーティングします。
- **チャネルの優先順位との連携**
  - New API で異なるチャネルに重み/優先順位を設定し、統一された標準モデル名と組み合わせることで、マルチアップストリームの障害回復とトラフィック分配を実現します。

## よくある質問

- **New API 設定の欠落の表示**
  - まず **「基本設定 → New API 統合設定」** で管理者 URL、トークン、ユーザー ID を入力して保存してください。
- **機能が有効になっていないという表示**
  - 「モデルリダイレクト」エリアで「モデルリダイレクトを有効にする」スイッチがオンになっていることを確認してください。
- **一部の標準モデルのマッピングが生成されない**
  - これは、対応するチャネルで一致する実際のモデルが見つからないか、すべての候補が他の標準モデルによって占有されていることを示します。
  - チャネルの `models` フィールドが完全であるかを確認するか、標準モデルリストを調整することができます。
- **既存の手動設定は上書きされますか？**
  - 同じ `standardModel` については、新しく生成されたマッピングが古い値を上書きします。
  - 手動で追加されたが上書きされなかった他のキーは、`model_mapping` に保持されます。

## 使用上のヒント

- まずテスト環境または少数のチャネルで生成結果を検証し、その後すべてのチャネルで一括リダイレクトを実行することをお勧めします。
- 主に **New API モデル同期** を通じてモデルリストを維持している場合、同期が完了した後に「マッピングを再生成」をクリックすることを推奨します。

## 関連ドキュメント

- [New API モデルリスト同期](./new-api-model-sync.md)
- [New API チャネル管理](./new-api-channel-management.md)
- [クイックサイト設定エクスポート](./quick-export.md)