# モデルリダイレクト（Model Redirect）

> New API チャネル用に「標準モデル → 実際モデル」のマッピングを自動生成し、下流では統一されたモデル名（例: `gpt-4o`）を呼び出すだけで、システムが自動的に各上流の中継ステーションで提供されているモデルにルーティングできるようにします。

## 機能概要

- **統一されたモデル呼び出しエントリポイント**
  - New API で「標準モデル名」（例: `gpt-4o`、`claude-4.5-haiku`）のセットを統一的に使用できます。
  - モデルリダイレクトは、これらを各チャネルで実際に利用可能なモデル名にマッピングします。
- **マッピングの自動生成**
  - チャネルから報告された `models` リストと「標準モデルリスト」に基づいて、最適な対応関係を自動的に計算します。
  - チャネルごとの増分マージをサポートし、手動で設定したマッピング部分を保持します。
- **モデル同期およびチャネル管理との連携**
  - 通常、**New API モデルリスト同期** および **New API チャネル管理** と組み合わせて使用されます。
    - モデル同期は、上流の利用可能なモデルリストを New API に取得する役割を担います。
    - モデルリダイレクトは、これらのモデルを「標準モデル」のセットに合わせる役割を担います。

## 前提条件

- プラグインで **New API 統合設定** が構成済みであること。
  - **管理者 URL**、**Admin Token**、**ユーザー ID** を入力済みであること。
- New API に少なくとも 1 つの有効なチャネルが存在し、そのチャネルの `models` フィールドに利用可能なモデルリストが含まれていること。
- モデル同期が一度完了していること（推奨）。これにより、チャネル内のモデルリストが最新であることを保証します。

## 設定エントリポイント

1. プラグインを開き → **設定** ページに移動します。
2. **「New API」** タブに切り替えます。
3. ページの下部にある **「モデルリダイレクト」** エリア（`id="model-redirect"`）を見つけます。
4. 以下が表示されます。
   - 有効化スイッチ
   - 標準モデルの複数選択リスト
   - 「マッピングを再生成する」ボタン

## 主要な設定項目

- **モデルリダイレクトを有効にする**
  - オンにすると、モデルリダイレクトアルゴリズムが、手動で「再生成」をクリックした際や特定の同期プロセス中に呼び出されます。
- **標準モデルリスト**
  - 一般的なベンダーの標準モデルが組み込まれています。例：
    - OpenAI シリーズ：`gpt-4o`、`gpt-4o-mini`、`o3`、`o3-mini` など。
    - Anthropic / Google / Mistral / DeepSeek / 通義千問などの主要モデル。
  - 必要に応じて追加・削除したり、カスタム標準モデル名を直接入力したりできます。
- **マッピングを再生成する**
  - ボタンをクリックすると、プラグインは以下の処理を行います。
    - すべてのチャネルリストを取得します（手動/自動で無効化されたチャネルは除外）。
    - 各チャネルに対して、「標準モデル → 実際モデル」のマッピングテーブルを計算します。
    - 結果を既存の `model_mapping` とマージして書き戻します（新しいキーは古い値を上書きします）。
- **モデルリダイレクトマッピングをクリア（危険な操作）**
  - クリックすると、まず **プレビュー/選択** ダイアログが開かれ、現在のサイト下のチャネルリストが読み込まれます。
    - デフォルトで全チャネルが **全選択** されます。
    - **全選択 / 全解除** のクイック操作が可能です。
    - クリアしたいチャネルを個別に選択できます。
  - プレビューダイアログで「続行」をクリックすると、**二次確認** が表示されます（誤操作防止のため）。
    - 確認後、選択されたチャネルに `model_mapping = "{}"` が書き込まれ、マッピングがクリアされます。
    - **選択されていないチャネルは変更されません**。
    - この操作は、手動で維持している可能性のあるカスタムマッピングをクリアし、**元に戻すことはできません**。
  - **一部失敗** が発生した場合：
    - プラグインは残りのチャネルのクリアを試行し続けます。
    - UI に成功/失敗の概要が表示され、失敗した詳細がダイアログに表示されるため、再試行や手動での処理が容易になります。

## 動作原理（概要）

1. ユーザー設定からモデルリダイレクトの設定を読み込みます。
   - 有効になっていない場合は、直接戻り、「機能はオフです」と表示します。
2. 標準モデルのセットを計算します。
   - カスタム設定がない場合は、組み込みの標準モデルの全セットを使用します。
3. New API 管理インターフェースを通じて、すべてのチャネルリストを取得します。
4. 各チャネルについて：
   - チャネルの `models` フィールドを解析して、実際モデルのリストを作成します。
   - 各標準モデルに対して、多段階マッチングを実行します。
     - チャネル自体に同名のモデルが含まれている場合はスキップします（リダイレクト不要）。
     - それ以外の場合は、統一された「モデル正規化ルール」（`renameModel`）に基づいて、最も近い候補の実際モデルを探します。
     - **バージョンガード**：同バージョンモデルのみをマッチング対象とし、バージョン間のダウングレード/アップグレードは行いません（例: `claude-4.5-sonnet` を `claude-3.5-sonnet` にマッピングしません。同バージョンの候補が見つからない場合は、その標準モデルをスキップします）。
     - 候補セットの中から、まだ使用されていない実際モデルを選択し、`standardModel -> actualModel` マッピングを書き込みます。
   - 新しいマッピングを、チャネルの既存の `model_mapping` JSON とマージして書き戻します。
5. 正常に更新されたチャネル数と失敗理由をまとめ、UI にトーストメッセージで表示します。

## 一般的な使用シナリオ

- **OpenAI 互換モデル名の統一**
  - 上流によってモデル名が若干異なる場合があります（例: 接頭辞/接尾辞が付いている）。
  - モデルリダイレクトを使用することで、下流アプリケーションでは常に統一された名前（例: `gpt-4o`）を使用でき、New API がマッピングに基づいて実際のモデルにルーティングします。
- **チャネル優先度との連携**
  - New API で異なるチャネルに重み/優先度を設定し、統一された標準モデル名と組み合わせることで、マルチ上流のフォールトトレランスとトラフィック分散を実現します。

## よくある質問

- **New API 設定の欠落を通知される**
  - **基本設定 → New API 統合設定** で、管理者 URL、Token、ユーザー ID を入力して保存してください。
- **機能が無効になっていると通知される**
  - 「モデルリダイレクト」エリアで「モデルリダイレクトを有効にする」スイッチがオンになっていることを確認してください。
- **一部の標準モデルでマッピングが生成されない**
  - 対応するチャネルでマッチング可能な実際モデルが見つからなかったか、すべての候補が他の標準モデルによって既に占有されていることを意味します。
  - また、そのチャネルに **同バージョンの** 候補モデルがない可能性もあります。プラグインはバージョンをまたいだダウングレード/アップグレードによるマッピング生成は行いません。
  - チャネルの `models` フィールドが完全かどうかを確認するか、標準モデルリストを調整してください。
- **既存の手動設定は上書きされますか？**
  - 同じ `standardModel` については、新しく生成されたマッピングが古い値を上書きします。
  - 上書きされなかった、手動で追加された他のキーは `model_mapping` に保持されます。

## 使用上の推奨事項

- まずはテスト環境または少数のチャネルで生成結果を確認してから、すべてのチャネルで一括リダイレクトを実行することをお勧めします。
- 主に **New API モデル同期** を使用してモデルリストを管理している場合は、同期完了後に「マッピングを再生成する」をクリックすることをお勧めします。

## 関連ドキュメント

- [New API モデルリスト同期](./new-api-model-sync.md)
- [New API チャネル管理](./new-api-channel-management.md)
- [サイト設定のクイックエクスポート](./quick-export.md)