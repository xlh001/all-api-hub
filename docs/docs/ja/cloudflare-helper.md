# Cloudflare 盾回避アシスタント

> Cloudflareの5秒盾（またはより厳格なBot Fight Mode）が有効になっているアグリゲート中継ステーション向け。プラグインがアカウント情報を認識し、リクエストが制限された際に自動的に再試行できるようにします。

## 機能概要

-   **自動検出**：ページタイトルに `Just a moment` が含まれている、`#cf-content` が存在している、またはAPIが401/403/429などのステータスコードを返した場合に、自動的に盾回避プロセスをトリガーします。
-   **一時ウィンドウ**：バックグラウンドでターゲットドメインと同オリジンの一時タブページを開き、ブラウザのCookieを継承して、CloudflareのJS/人間認証チャレンジを完了した後に元のページに戻ります。
-   **リクエストのフォールバック**：通常の `fetch` が失敗した場合、一時ウィンドウがCookieを保持してリクエストを再送信することで、クロスオリジン/認証情報不足による無限の再試行を回避します。
-   **手動フォールバック**：Cloudflareがユーザーインタラクションが必要と判断した場合、20秒以内に検証を完了するよう促すウィンドウが自動的にポップアップ表示されます。

## 使用手順

1.  **ターゲットサイトにログイン**し、プラグインでアカウントを追加 → サイトアドレスを入力 → 「自動認識」をクリックします。
2.  Cloudflareのプロンプトが表示された場合、ブラウザが自動的にポップアップウィンドウを開きます。ウィンドウをフォアグラウンドに保ち、自動検証が完了するのを待つか、指示に従って選択してください。
3.  検証が完了すると、プラグインは自動的に認識プロセスに戻り、Access Token、残高、モデルリストなどのデータを読み込み続けます。
4.  APIリクエスト段階でレート制限がトリガーされた場合（CC Switch/CherryStudioのエクスポートやNew APIの同期でよく見られます）、システムは自動的に一時ウィンドウを有効にして再送信します。追加の操作は不要です。

## 注意事項

-   **IPの品質**：連続して通過できない場合、ネットワークを変更するか、サイト側で一時的に保護を緩和する必要があります。デフォルトのタイムアウト時間は20秒です。
-   **ポップアップ権限**：ブラウザのポップアップウィンドウを許可してください。そうしないと、プラグインは一時タブページを作成できません。
-   **繰り返しのチャレンジ**：頻繁に429がトリガーされる場合、New APIのチャネル管理でレートを下げたり、モデルのホワイトリストを有効にしたりして、無効なリクエストを減らすことができます。

## よくある質問

| シナリオ | 解決策 |
|------|----------|
| ポップアップがすぐに閉じる | ブラウザのアドレスバー右側でポップアップがブロックされていないか確認し、許可してから再度認識してください。 |
| 「Just a moment」に留まり続ける | ポップアップウィンドウで手動で認証コードを完了してください。それでも失敗する場合は、IPを変更してください。 |
| APIエクスポートで引き続き403エラーが発生する | 「再度エクスポート」を手動でクリックすると、バックグラウンドで盾回避を通過したばかりのCookieが再利用されます。失敗する場合は、ターゲットサイトが管理者トークンを制限していないか確認してください。 |
| ポップアップなしで認識に失敗する | サイトがCloudflareを削除した可能性がありますが、インターフェースが401（認証情報の期限切れ）を返しています。サイトに再ログインし、プラグインデータを更新してください。 |

## 関連ドキュメント

-   [Cloudflare保護と一時ウィンドウのフォールバック（クイックスタート）](./get-started.md#_5-8-cloudflare-防护与临时窗口降级)
-   [サイトのクイックエクスポート](./quick-export.md)
-   [New API チャネル管理](./new-api-channel-management.md)