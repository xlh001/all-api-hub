# Cloudflare シールド回避アシスタント

> Cloudflareの5秒シールド（またはより厳格なBot Fight Mode）が有効になっているアグリゲートプロキシステーションに適用され、プラグインがアカウント情報を認識できるだけでなく、リクエストが制限された際に自動でリトライできるようにします。

## 機能概要

-   **自動検出**: ページタイトルに `Just a moment` が含まれている、`#cf-content` が存在している、またはAPIが401/403/429などのステータスコードを返した場合に、自動的にシールド回避プロセスをトリガーします。
-   **一時ウィンドウ**: バックグラウンドでターゲットドメインと同じオリジンの仮のタブを開き、ブラウザのCookieを引き継いでCloudflareのJS/人間性チャレンジを完了させ、元のページに戻ります。
-   **リクエスト降格**: 通常の `fetch` が失敗した場合、仮のウィンドウがCookieを保持してリクエストを再送することで、クロスドメイン/資格情報不足による無限リトライを回避します。
-   **手動フォールバック**: Cloudflareがユーザーのインタラクションが必要と判断した場合、20秒以内に検証を完了するよう促すポップアップウィンドウが自動的に表示されます。

## 使用手順

1.  **ターゲットサイトにログイン**し、プラグインでアカウントを新規追加 → サイトアドレスを入力 → 「自動認識」をクリックします。
2.  Cloudflareのプロンプトが表示された場合、ブラウザが自動的にポップアップウィンドウを表示します。ウィンドウをフォアグラウンドに保ち、自動検証の完了を待つか、指示に従って選択してください。
3.  検証が完了すると、プラグインは自動的に認識プロセスに戻り、Access Token、残高、モデルリストなどのデータを引き続き読み取ります。
4.  APIリクエスト段階でレート制限がトリガーされた場合（CC Switch/CherryStudioのエクスポートまたはNew APIの同期でよく発生します）、システムは自動的に仮のウィンドウを有効にして再送信します。追加の操作は不要です。

## 注意事項

-   **IPの品質**: 連続して通過できない場合は、ネットワークを変更するか、サイト側で一時的に保護を緩和する必要があります。デフォルトのタイムアウト時間は20秒です。
-   **ポップアップ権限**: ブラウザのポップアップウィンドウを許可してください。そうしないと、プラグインは一時タブを作成できません。
-   **繰り返しチャレンジ**: 頻繁に429がトリガーされる場合は、New APIのチャネル管理でレートを下げたり、モデルのホワイトリストを有効にしたりして、無効なリクエストを減らすことができます。

## よくある質問

| シナリオ | 解決策 |
|----------|----------|
| ポップアップが一瞬で閉じる | ブラウザのアドレスバー右側でポップアップがブロックされていないか確認し、許可してから再度認識を試みてください。 |
| ずっと「Just a moment」のまま停止している | ポップアップウィンドウで手動で検証コードを完了してください。それでも失敗する場合は、IPを変更してください。 |
| APIエクスポートがまだ403エラーを報告する | 手動で「再エクスポート」をクリックしてください。バックグラウンドでシールド回避に成功したばかりのCookieが再利用されます。失敗する場合は、ターゲットサイトが管理者Tokenを制限していないか確認してください。 |
| ポップアップなしで認識失敗 | サイトがCloudflareを削除した可能性がありますが、インターフェースが401（資格情報失効）を返しています。サイトに再ログインし、プラグインデータを更新してください。 |

## 関連ドキュメント

-   [Cloudflare 保護と一時ウィンドウの降格（クイックスタート）](./get-started.md#_5-8-cloudflare-防护与临时窗口降级)
-   [サイトのクイックエクスポート](./quick-export.md)
-   [New API チャネル管理](./new-api-channel-management.md)
-   [権限管理（オプションの権限）](./permissions.md)